<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Halo Content Converter</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 2em;
      background-color: #121212;
      color: #e0e0e0;
    }
    h1, h2 {
      color: #ffffff;
    }
    .drop-zone {
      border: 2px dashed #555;
      padding: 2em;
      text-align: center;
      color: #ccc;
      margin-bottom: 1em;
      background-color: #1e1e1e;
    }
    .output {
      white-space: pre-wrap;
      background: #1e1e1e;
      padding: 1em;
      margin-top: 1em;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 6px;
    }
    button {
      margin-top: 1em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      background-color: #2d89ef;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    input[type="file"] {
      color: #ccc;
    }
    .faq {
      margin-top: 3em;
      background-color: #1e1e1e;
      padding: 1.5em;
      border-radius: 6px;
      border: 1px solid #333;
    }
    .faq h2 {
      margin-top: 0;
    }
    .faq-item {
      margin-bottom: 1.5em;
    }
    .faq-item h3 {
      margin-bottom: 0.2em;
      color: #89dceb;
    }
    .faq-item p {
      margin: 0;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>Halo Content Converter</h1>
  <div class="drop-zone" id="drop-zone">
    Drag & drop files here or <input type="file" multiple id="file-input" />
  </div>
  <button id="convert-btn" disabled>Convert Files</button>
  <div class="output" id="output"></div>

  <!-- FAQ Section -->
  <div class="faq" id="faq">
    <h2>FAQ</h2>
    <div class="faq-item">
    <h3>Where can I find my Halo Xbox 360 container files?</h3>
    <p>Once you've copied the files you want to convert to a USB drive, you can find the container files in the following directories:</p>
    <ul>
      <li><strong>Halo 3:</strong> <code>Content/E0000.../4D5307E6/00000001</code></li>
      <li><strong>Halo 3: ODST:</strong> <code>Content/E0000.../4D530877/00000001</code></li>
      <li><strong>Halo: Reach:</strong> <code>Content/E0000.../4D53085B/00000001</code></li>
      <li><strong>Halo 4:</strong> <code>Content/E0000.../4D530919/00000001</code></li>
    </ul>
    <p>The files inside these folders are your container files.</p>
    </div>
    <div class="faq-item">
      <h3>How do I get these into MCC?</h3>
      <p>Drop the .bin files into the 'game_variants' folder & .mvar files into the 'map_variants' folder for their respective games.</p>
    </div>
    <div class="faq-item">
      <h3>What can I do with .film files?</h3>
      <p>Nothing at the moment as the films will not show up in MCC, maybe one day we can do some magic and port these forward...</p>
    </div>
    <div class="faq-item">
      <h3>Is my file data stored or sent anywhere?</h3>
      <p>All file processing happens locally in the browser. No server interaction.</p>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("file-input");
    const dropZone = document.getElementById("drop-zone");
    const output = document.getElementById("output");
    const convertBtn = document.getElementById("convert-btn");

    let selectedFiles = [];

    const getString = (bytes, offset, length) => {
      return new TextDecoder("ascii").decode(bytes.slice(offset, offset + length)).replace(/\0/g, '').trim();
    };

    const findIndexOfString = (bytes, str, start = 0) => {
      const target = new TextEncoder().encode(str);
      for (let i = start; i < bytes.length - target.length; i++) {
        let match = true;
        for (let j = 0; j < target.length; j++) {
          if (bytes[i + j] !== target[j]) {
            match = false;
            break;
          }
        }
        if (match) return i;
      }
      return -1;
    };

    const findIndexOfBytes = (bytes, pattern, start = 0) => {
      for (let i = start; i <= bytes.length - pattern.length; i++) {
        let match = true;
        for (let j = 0; j < pattern.length; j++) {
          if (bytes[i + j] !== pattern[j]) {
            match = false;
            break;
          }
        }
        if (match) return i;
      }
      return -1;
    };

    const sanitizeFilename = (name) => {
      return name.replace(/[\\/:*?"<>|]/g, "_");
    };

    const triggerDownload = (blob, filename) => {
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const processFile = async (file) => {
      try {
        const buffer = await file.arrayBuffer();
        const bytes = new Uint8Array(buffer);

        const fileContent = new TextDecoder("ascii").decode(bytes);
        const blfIndex = fileContent.indexOf("_blf");
        if (blfIndex === -1){
          output.innerText += `\nValid header not found, skipping: ${file.name}...\n `;
          return;
        } 

        const content = getString(bytes, 0xD0C0, 0x7F);
        const sanitizedContent = sanitizeFilename(content);
        const creatorName = getString(bytes, 0xD088, 0x0F);
        const creatorXUID = Array.from(bytes.slice(0xD080, 0xD088)).map(b => b.toString(16).padStart(2, '0')).join('');
        const modifierName = getString(bytes, 0xD0AC, 0x0F);
        const modifierXUID = Array.from(bytes.slice(0xD0A4, 0xD0AC)).map(b => b.toString(16).padStart(2, '0')).join('');
        const description = getString(bytes, 0xD1C0, 0xFF);
        const headerType = getString(bytes, 0xD2F0, 0x04);

        const typeMap = {
          "mpvr": { type: "Gametypes", ext: ".bin" },
          "mapv": { type: "H3 map variants", ext: ".mavr"},
          "mvar": { type: "Map variants", ext: ".mvar" },
          "athr": { type: "Theater films", ext: ".film" },
          "scnc": { type: "Screenshots", ext: ".jpg" }
        };

        if (!(headerType in typeMap)) {
          output.innerText += `\nValid header not found, skipping: ${file.name}...\n `;
          return;
        }

        output.innerText += `\nFile: ${file.name}
        Creator: ${creatorName} (XUID: ${creatorXUID})
        Modifier: ${modifierName} (XUID: ${modifierXUID})
        Content: ${content}
        Description: ${description}
        Header Type: ${headerType}\n`;

        if (headerType === "scnc") {
          const jpgStartMarker = [0xFF, 0xD8, 0xFF, 0xE0];
          const jpgEndMarker = [0xFF, 0xD9];

          const jpgStart = findIndexOfBytes(bytes, jpgStartMarker, blfIndex);
          const jpgEnd = findIndexOfBytes(bytes, jpgEndMarker, jpgStart);
          if (jpgStart === -1 || jpgEnd === -1) return;

          const jpgBytes = bytes.slice(jpgStart, jpgEnd + 2);
          const blob = new Blob([jpgBytes], { type: "image/jpeg" });
          triggerDownload(blob, sanitizedContent + ".jpg");
          return;
        }

        const stopIndex = findIndexOfString(bytes, "_eof", blfIndex);
        if (stopIndex === -1) return;

        const extracted = bytes.slice(blfIndex, stopIndex + 4 + 0x0D);
        const { ext } = typeMap[headerType];
        const blob = new Blob([extracted], { type: "application/octet-stream" });
        triggerDownload(blob, sanitizedContent + ext);
      } catch (e) {
        output.innerText += `Error processing file ${file.name}: ${e.message}\n`;
      }
    };

    const handleFiles = (files) => {
      selectedFiles = Array.from(files);
      output.innerText = `${selectedFiles.length} file(s) ready to convert.\nClick "Convert Files" to proceed.`;
      convertBtn.disabled = false;
    };

    fileInput.addEventListener("change", () => handleFiles(fileInput.files));
    dropZone.addEventListener("dragover", e => e.preventDefault());
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      handleFiles(e.dataTransfer.files);
    });

    convertBtn.addEventListener("click", async () => {
      output.innerText += "\nProcessing files...\n";
      for (const file of selectedFiles) {
        await processFile(file);
        await new Promise(resolve => setTimeout(resolve, 150));
      }
      output.innerText += "\nAll files processed.";
      convertBtn.disabled = true;
    });
  </script>
</body>
</html>
